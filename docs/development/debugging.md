# Debugging Guide: Run Identification & Error Tracking

This guide explains how to use the four debugging identifiers (`trace_id`, `run_id`, `thread_id`, `request_id`) to effectively debug issues in Deep Agent AGI.

## Quick Reference: The Four Identifiers

| ID | Scope | Lifespan | Best Used For |
|----|-------|----------|---------------|
| **`trace_id`** | Single trace (LangSmith) | One complete operation | Debugging entire execution flow in LangSmith UI |
| **`run_id`** | Single run/checkpoint | One agent invocation | Debugging specific agent execution, HITL workflows |
| **`thread_id`** | Conversation thread | Multiple messages | Identifying user session, retrieving conversation history |
| **`request_id`** | WebSocket request | Single request/response | Debugging network issues, request/response matching |

---

## 1. trace_id (Most Important for Debugging)

### What It Is
- **LangSmith trace identifier** - Links directly to a specific execution trace in LangSmith UI
- Automatically generated by LangSmith when tracing is enabled
- Captured after every agent invocation in our system

### When to Use
- **Primary debugging tool** - Use this first when investigating errors
- Provides the most comprehensive view of what happened during execution
- Shows all LLM calls, tool executions, timing data, and errors

### How to Find It
**In Backend Logs:**
```python
# Error log example
{
  "level": "error",
  "message": "Agent invocation failed",
  "thread_id": "user-abc-123",
  "trace_id": "1a2b3c4d-5e6f-7890-abcd-ef1234567890",
  "langsmith_url": "https://smith.langchain.com/public/1a2b3c4d-5e6f-7890-abcd-ef1234567890/r",
  "error": "Connection timeout"
}
```

**In API Responses:**
```json
{
  "error": "Agent execution failed",
  "thread_id": "user-abc-123",
  "trace_id": "1a2b3c4d-5e6f-7890-abcd-ef1234567890"
}
```

### What You Can See in LangSmith
1. **Complete execution timeline** - Every step from input to output
2. **LLM calls** - Prompts sent, responses received, token usage
3. **Tool executions** - Which tools were called, with what arguments, and results
4. **Timing breakdown** - Latency for each step
5. **Error details** - Exact location where error occurred with stack traces

### Example Workflow
```bash
# 1. User reports error
# 2. Check backend logs for the error
grep "Agent invocation failed" backend.log

# 3. Extract trace_id and langsmith_url from log
# 4. Click langsmith_url to open trace in LangSmith UI
# 5. Investigate execution flow to find root cause
```

---

## 2. thread_id (Conversation Context)

### What It Is
- **Conversation thread identifier** - Groups all messages in a single conversation
- User-provided or auto-generated for each new conversation
- Persisted across multiple messages and agent invocations

### When to Use
- Understanding conversation context ("What was the user trying to do?")
- Retrieving conversation history from checkpointer
- Identifying which user/session had an issue

### How to Find It
**In Backend Logs:**
```python
{
  "level": "info",
  "message": "Invoking agent",
  "thread_id": "d04fd9af-95ad-4cb2-b2a2-e6a296feb0bf",
  "message_length": 30
}
```

**In Database:**
```python
# Retrieve conversation history
from deep_agent.services.agent_service import AgentService

service = AgentService()
state = await service.get_state(thread_id="d04fd9af-95ad-4cb2-b2a2-e6a296feb0bf")
messages = state["values"]["messages"]
```

### Relationship to trace_id
- One `thread_id` can have **many** `trace_id`s (one per message)
- Example:
  ```
  thread_id: user-conversation-123
  ├─ Message 1 → trace_id: abc-111
  ├─ Message 2 → trace_id: abc-222
  ├─ Message 3 → trace_id: abc-333 ❌ (error here)
  └─ Message 4 → trace_id: abc-444
  ```

---

## 3. run_id (LangGraph Checkpoint)

### What It Is
- **LangGraph checkpoint identifier** - Points to a specific state snapshot
- Extracted from LangGraph's internal state management
- Unique per agent invocation within a thread

### When to Use
- Debugging HITL (Human-in-the-Loop) workflows
- Inspecting agent state at a specific point in time
- Understanding checkpoint history

### How to Find It
**In Backend Logs:**
```python
{
  "level": "info",
  "message": "Agent status retrieved successfully",
  "thread_id": "user-123",
  "run_id": "1f0b586a-3725-63b8-bfff-86b59fad36fd",
  "status": "running"
}
```

**Programmatically:**
```python
# Get run_id from state
state = await service.get_state(thread_id="user-123")
run_id = state["config"]["configurable"].get("checkpoint_id")
```

### Common Use Cases
- **HITL debugging** - "Which checkpoint is waiting for approval?"
- **State inspection** - "What was the agent's state when it failed?"
- **Rollback** - "Can we resume from a previous checkpoint?"

---

## 4. request_id (WebSocket Tracking)

### What It Is
- **WebSocket request identifier** - Tracks individual WebSocket messages
- Generated per message sent over WebSocket connection
- Used for network-level debugging

### When to Use
- Debugging WebSocket connection issues
- Matching requests with responses
- Investigating message delivery problems

### How to Find It
**In Backend Logs:**
```python
{
  "level": "info",
  "message": "WebSocket message received",
  "connection_id": "6eba57a4-3d07-417b-878c-d2cf5834f446",
  "request_id": "108e3595-402e-4b65-a5d0-82dc61a6f810",
  "thread_id": "d04fd9af-95ad-4cb2-b2a2-e6a296feb0bf"
}
```

**In WebSocket Error Responses:**
```json
{
  "type": "error",
  "error": "Agent execution failed",
  "request_id": "108e3595-402e-4b65-a5d0-82dc61a6f810",
  "thread_id": "d04fd9af-95ad-4cb2-b2a2-e6a296feb0bf",
  "trace_id": "1a2b3c4d-5e6f-7890-abcd-ef1234567890"
}
```

---

## Debugging Workflows

### Scenario 1: User Reports "Chat is broken"

**Step 1:** Get identifiers from user
```
User: "My chat isn't working. Thread ID: user-abc-123"
```

**Step 2:** Check backend logs for that thread_id
```bash
grep "thread_id=user-abc-123" backend.log | tail -20
```

**Step 3:** Find the most recent error with trace_id
```
ERROR: Agent invocation failed
  thread_id: user-abc-123
  trace_id: abc-def-123
  langsmith_url: https://smith.langchain.com/public/abc-def-123/r
```

**Step 4:** Open LangSmith trace URL
- Click the `langsmith_url` to see full execution
- Identify where it failed (LLM call? Tool execution? Network?)

**Step 5:** Fix the root cause based on LangSmith findings

---

### Scenario 2: HITL Approval Not Working

**Step 1:** Get thread_id and check agent status
```bash
curl http://localhost:8000/api/v1/agents/user-abc-123
```

**Response:**
```json
{
  "run_id": "1f0b586a-3725-63b8-bfff-86b59fad36fd",
  "thread_id": "user-abc-123",
  "status": "running",
  "trace_id": "trace-xyz-789"
}
```

**Step 2:** Check if agent is waiting for approval
- Look at backend logs for HITL-related messages
- Search for `run_id` in logs to see approval flow

**Step 3:** Inspect checkpoint state
```python
state = await service.get_state(
    thread_id="user-abc-123",
    checkpoint_id="1f0b586a-3725-63b8-bfff-86b59fad36fd"
)
# Check if state has "approved" field or HITL metadata
```

---

### Scenario 3: WebSocket Connection Drops

**Step 1:** Check WebSocket connection logs
```bash
grep "WebSocket connection" backend.log
```

**Output:**
```
INFO: WebSocket connection established, connection_id=xyz-123
INFO: WebSocket message received, request_id=req-456, thread_id=user-789
ERROR: WebSocket agent execution failed, request_id=req-456, trace_id=trace-abc
INFO: WebSocket client disconnected, connection_id=xyz-123
```

**Step 2:** Correlate request_id with error
- Find which `request_id` failed
- Get the `trace_id` for that request
- Open LangSmith trace to see what happened

---

## API Error Response Format

All API errors now include debugging identifiers:

### REST Endpoints
```json
{
  "error": "Agent execution failed",
  "detail": "Connection timeout after 30 seconds",
  "thread_id": "user-123",
  "trace_id": "trace-abc-456",
  "run_id": "run-def-789"
}
```

### WebSocket Errors
```json
{
  "type": "error",
  "error": "Agent execution failed",
  "request_id": "req-ghi-012",
  "thread_id": "user-123",
  "trace_id": "trace-abc-456"
}
```

---

## Best Practices

### For Users Reporting Issues
Include **Thread ID** and **Reference ID** (trace_id) when reporting errors:
```
"I'm getting an error in my chat.
Thread: user-abc-123
Reference: trace-xyz-789"
```

### For Developers Debugging
1. **Start with `trace_id`** - Open LangSmith trace first
2. **Check `thread_id`** - Get conversation context if needed
3. **Use `run_id`** - Only for HITL or checkpoint-specific issues
4. **Use `request_id`** - Only for WebSocket/network problems

### For Production Monitoring
- Set up alerts on error logs that include `trace_id`
- Create dashboards grouping errors by `thread_id` (user sessions)
- Track `trace_id` distribution to identify recurring issues

---

## LangSmith Trace URL Format

All backend error logs include a direct LangSmith URL:
```
langsmith_url: https://smith.langchain.com/public/{trace_id}/r
```

**Example:**
```
https://smith.langchain.com/public/1a2b3c4d-5e6f-7890-abcd-ef1234567890/r
```

Click this URL to immediately see the full execution trace without needing to search for it in LangSmith.

---

## Code Examples

### Accessing Identifiers in Code

**Get trace_id after invocation:**
```python
from deep_agent.services.agent_service import AgentService

service = AgentService()
result = await service.invoke(
    message="Hello",
    thread_id="user-123"
)

# trace_id is included in result
trace_id = result.get("trace_id")
print(f"LangSmith trace: https://smith.langchain.com/public/{trace_id}/r")
```

**Get run_id from state:**
```python
state = await service.get_state(thread_id="user-123")
run_id = state["config"]["configurable"].get("checkpoint_id")
```

**Generate LangSmith URL:**
```python
from deep_agent.core.logging import generate_langsmith_url

trace_id = "1a2b3c4d-5e6f-7890-abcd-ef1234567890"
url = generate_langsmith_url(trace_id)
print(url)  # https://smith.langchain.com/public/.../r
```

---

## Troubleshooting Common Issues

### "I don't see a trace_id in the logs"
- **Cause:** LangSmith tracing may not be enabled
- **Fix:** Check `.env` has `LANGSMITH_API_KEY` and `LANGSMITH_TRACING_V2=true`

### "LangSmith URL returns 404"
- **Cause:** Trace might not be public or doesn't exist
- **Fix:** Verify trace exists in LangSmith project, check API key permissions

### "Multiple trace_ids for same error"
- **Cause:** Retries or multiple invocations in the same thread
- **Fix:** Use the **most recent** `trace_id` from logs (latest timestamp)

---

## Summary

**For quick debugging:**
1. Get `trace_id` from error logs or API response
2. Click the `langsmith_url` to open trace in LangSmith
3. Investigate execution flow to find root cause

**For comprehensive debugging:**
- **`trace_id`** - What happened in this specific execution?
- **`thread_id`** - What was the conversation context?
- **`run_id`** - What was the checkpoint state?
- **`request_id`** - Was there a network issue?

**Always start with `trace_id` - it provides the most detailed view of what went wrong.**
